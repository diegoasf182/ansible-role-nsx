#
#  Copyright 2015 VMware, Inc.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
#
---
- name: Get Edge Ip pool id
  shell: awk -F = '/{{ item }}/ { print $2 }' "{{ ippoolids }}"
  with_items:
    - "{{ edgevtep_ippool_name }}"
  register: edge_ippool

- name: set fact for edge ip pool id
  set_fact:
    edge_id: "{{ item.stdout }}"
  with_items: "{{ edge_ippool.results }}"

- name: Get Compute Ip pool id
  shell: awk -F = '/{{ item }}/ { print $2 }' "{{ ippoolids }}"
  with_items:
    - "{{ computevtep_ippool_name }}"
  register: compute_ippool

- name: set fact for compute ip pool id
  set_fact:
    compute_id: "{{ item.stdout }}"
  with_items: "{{ compute_ippool.results }}"

- name: create xml for request
  template: src="{{ vxlan_xml }}" dest="{{ nsx_tmp }}/{{ item.clusterid }}_vxlan.xml"
  with_items:
    - { clusterid: "{{ vio_cluster_edge_id }}", mainvds: "{{ vio_vds_id }}", portgroup: "{{ vio_mgmtpg_id }}" , ippoolid: "{{ edge_id }}", vlanid: "{{ vxlan_vlanid }}", vmknic: "{{ vxlan_vmnic }}", teaming: "{{ vxlan_teaming }}" }
    - { clusterid: "{{ vio_cluster_compute_id }}", mainvds: "{{ vio_vds_id }}", portgroup: "{{ vio_mgmtpg_id }}" , ippoolid: "{{ compute_id }}", vlanid: "{{ vxlan_vlanid }}", vmknic: "{{ vxlan_vmnic }}", teaming: "{{ vxlan_teaming }}" }
